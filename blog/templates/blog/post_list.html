{% extends "base.html" %}
{% load static %}

{% block title %}Blog ‚Äî Cuidados y Consejos{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'blog/css/blog.css' %}?v={% now 'U' %}">
<style>
  /* Evita que capas decorativas tapen el formulario */
  .blog-hero { position: relative; z-index: 0; }
  .blog-hero::before, .blog-hero::after { pointer-events: none; }
  .blog-search { position: relative; z-index: 5; }
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'blog/js/blog.js' %}?v={% now 'U' %}" defer></script>
<script>
  // Refuerzo: si algo bloquea el submit nativo, lo forzamos al click.
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.querySelector('.blog-search');
    if (!form) return;
    const btn = form.querySelector('button[type="submit"]');
    if (btn) {
      btn.addEventListener('click', function () {
        form.submit();
      });
    }
  });
</script>
{% endblock %}

{% block content %}
<section class="blog-hero">
  <div class="blog-hero__icon" aria-hidden="true">
    <svg viewBox="0 0 48 48"><path fill="currentColor" d="M20.3 25.6c-2.6.5-4.6 2.7-4.6 5.3c0 3 2.4 5.4 5.4 5.4c1.6 0 3-.7 4-1.8c1 1.1 2.4 1.8 4 1.8c3 0 5.4-2.4 5.4-5.4c0-2.6-1.9-4.8-4.6-5.3c-2.4-.4-4.6-1.1-6.4-2.1c-1.8 1-4 1.7-6.4 2.1zM13.8 20.7a4.3 4.3 0 1 0 0-8.6a4.3 4.3 0 0 0 0 8.6zm20.4 0a4.3 4.3 0 1 0 0-8.6a4.3 4.3 0 0 0 0 8.6zM23.4 18a5 5 0 1 0 0-10a5 5 0 0 0 0 10zm1.2 0a5 5 0 1 0 0-10a5 5 0 0 0 0 10z"/></svg>
  </div>
  <h1 class="blog-hero__title">Blog de cuidados y consejos</h1>
  <p class="blog-hero__subtitle">Encuentra gu√≠as, tips y buenas pr√°cticas para el bienestar de tus mascotas.</p>

  <!-- IMPORTANTE: acci√≥n directa al listado y novalidate -->
  <form class="blog-search" method="get" action="{% url 'blog:post_list' %}" novalidate data-autosubmit>
    <input class="blog-search__input" type="search" name="q" value="{{ q|default:'' }}" placeholder="Buscar por t√≠tulo, tema o etiqueta‚Ä¶">
    <button class="btn btn--primary" type="submit">Buscar</button>
  </form>

  {% if q or tag or cat %}
    <div class="active-filters" style="margin-top:.6rem">
      {% if q %}<span class="chip chip--hero">üîé {{ q }}</span>{% endif %}
      {% if tag %}<span class="chip chip--hero">üè∑Ô∏è {{ tag }}</span>{% endif %}
      {% if cat %}<span class="chip chip--hero">üìÇ {{ cat }}</span>{% endif %}
      <a class="btn btn--ghost" href="{% url 'blog:post_list' %}">Quitar filtros</a>
    </div>
  {% endif %}
</section>

{% if posts %}
  <section class="posts-grid">
    {% for post in posts %}
      <article class="post-card js-reveal">
        <a class="post-card__media" href="{% url 'blog:post_detail' post.slug %}">
          {% if post.hero_image %}
            <img loading="lazy" src="{{ post.hero_image.url }}" alt="Imagen de {{ post.title }}">
          {% else %}
            <img loading="lazy" src="{% static 'blog/img/default-cat.svg' %}" alt="Imagen por defecto">
          {% endif %}
        </a>

        <div class="post-card__body">
          <div class="post-card__meta">
            {% if post.category %}
              <a class="link-muted" href="{% url 'blog:post_list' %}?cat={{ post.category.slug }}">{{ post.category.name }}</a>
              <span class="dot">‚Ä¢</span>
            {% endif %}
            {% if post.published_at %}
              <time datetime="{{ post.published_at|date:'c' }}">{{ post.published_at|date:"d M Y" }}</time>
              <span class="dot">‚Ä¢</span>
            {% endif %}
            {% if post.author %}
              <span class="muted">por {{ post.author.username|default:post.author }}</span>
            {% endif %}
          </div>

          <h2 class="post-card__title">
            <a href="{% url 'blog:post_detail' post.slug %}">{{ post.title }}</a>
          </h2>

          <p class="post-card__excerpt">
            {{ post.content|striptags|truncatewords:40 }}
          </p>

          {% if post.tags.all %}
            <div class="post-card__tags">
              {% for t in post.tags.all %}
                <a class="chip chip--ghost" href="{% url 'blog:post_list' %}?tag={{ t.slug }}">#{{ t.name }}</a>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </article>
    {% endfor %}
  </section>
{% else %}
  <p class="empty">No se encontraron art√≠culos para tu b√∫squeda.</p>
{% endif %}
{% endblock %}