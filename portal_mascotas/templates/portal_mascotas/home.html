{% extends "base.html" %}
{% load static %}

{% block title %}Adopciones disponibles{% endblock %}

{% block content %}

{# ================== MODO SELECTOR / MODO FORMULARIO ================== #}
{% if modo_selector %}
  <section style="display:grid;grid-template-columns:repeat(12,1fr);gap:16px">
    <article style="grid-column:span 12;background:#fff;border:1px solid #E5E7EB;border-radius:14px;padding:18px">
      <h1 style="margin:0 0 10px;">¬øQu√© deseas hacer?</h1>
      <p style="margin:0 0 14px;color:#6b7280">Elige una opci√≥n para continuar.</p>

      <div style="display:grid;grid-template-columns:repeat(12,1fr);gap:14px">
        <!-- Opci√≥n 1: Publicar -->
        <div style="grid-column:span 6;background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;padding:16px">
          <h3 style="margin:0 0 6px;">Publicar una mascota</h3>
          <p style="margin:0 0 12px;color:#6b7280">Completa el formulario con los datos de tu mascota para enviarlo a revisi√≥n.</p>
          {% if request.user.is_authenticated %}
            <a href="{% url 'registro_mascotas:publicar_mascota' %}?modo=form" class="btn btn-primary"
               style="display:inline-block;background:#10B981;color:#fff;padding:10px 14px;border-radius:10px;text-decoration:none;font-weight:600">
              Publicar ahora
            </a>
          {% else %}
            <a href="{% url 'login:login' %}?next={% url 'registro_mascotas:publicar_mascota' %}%3Fmodo%3Dform" class="btn btn-primary"
               style="display:inline-block;background:#10B981;color:#fff;padding:10px 14px;border-radius:10px;text-decoration:none;font-weight:600">
              Inicia sesi√≥n para publicar
            </a>
          {% endif %}
        </div>

        <!-- Opci√≥n 2: Ver estado -->
        <div style="grid-column:span 6;background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;padding:16px">
          <h3 style="margin:0 0 6px;">Ver estado de mis publicaciones</h3>
          <p style="margin:0 0 12px;color:#6b7280">Revisa si fue aprobada o rechazada. Incluye el mensaje de aceptaci√≥n o el motivo del rechazo.</p>
          {% if request.user.is_authenticated %}
            <a href="{% url 'registro_mascotas:mis_solicitudes' %}" class="btn btn-secondary"
               style="display:inline-block;background:#E5E7EB;color:#111827;padding:10px 14px;border-radius:10px;text-decoration:none;font-weight:600">
              Ver estado
            </a>
          {% else %}
            <a href="{% url 'login:login' %}?next={% url 'registro_mascotas:mis_solicitudes' %}" class="btn btn-secondary"
               style="display:inline-block;background:#E5E7EB;color:#111827;padding:10px 14px;border-radius:10px;text-decoration:none;font-weight:600">
              Inicia sesi√≥n para ver estado
            </a>
          {% endif %}
        </div>
      </div>
    </article>
  </section>

{% elif modo_publicar %}
  <section class="ap-card">
    <h2 class="ap-title">üêæ {{ titulo_publicar|default:'Publicar mascota en adopci√≥n' }}</h2>
    <p class="ap-note">Los campos con <span aria-hidden="true" class="ap-required">*</span> son obligatorios.</p>

    <form method="post" enctype="multipart/form-data" class="ap-form">
      {% csrf_token %}

      <div class="ap-field">
        <label for="id_nombre">Nombre <span class="ap-required">*</span></label>
        {{ form_publicar.nombre }}
      </div>

      <div class="ap-field">
        <label for="id_tipo">Tipo <span class="ap-required">*</span></label>
        {{ form_publicar.tipo }}
      </div>

      <div class="ap-field">
        <label for="id_sexo">Sexo <span class="ap-required">*</span></label>
        {{ form_publicar.sexo }}
      </div>

      <div class="ap-field">
        <label for="id_raza">Raza <span class="ap-required">*</span></label>
        {{ form_publicar.raza }}
      </div>

      <div class="ap-field">
        <label for="id_edad">Edad (meses) <span class="ap-required">*</span></label>
        {{ form_publicar.edad }}
      </div>

      <div class="ap-field ap-span-2">
        <label for="id_ubicacion">Ubicaci√≥n <span class="ap-required">*</span></label>
        {{ form_publicar.ubicacion }}
      </div>

      <div class="ap-field ap-span-2">
        <label for="id_descripcion">Descripci√≥n <span class="ap-required">*</span></label>
        {{ form_publicar.descripcion }}
      </div>

      <div class="ap-field ap-span-2">
        <label for="id_foto">Foto <span class="ap-required">*</span></label>
        {{ form_publicar.foto }}
        <small class="ap-help">Formatos admitidos: JPG, PNG, WEBP.</small>
      </div>

      <div class="ap-actions ap-span-2">
        <button type="submit" class="btn btn-primary">Enviar solicitud</button>
        <a href="{{ request.path }}" class="btn btn-secondary">Cancelar</a>
      </div>
    </form>
  </section>

  <style>
    .ap-card{margin:16px 0;padding:20px;background:#fff;border:1px solid #E5E7EB;border-radius:14px;box-shadow:0 4px 10px rgba(0,0,0,.04)}
    .ap-title{margin:0 0 6px;font-size:1.5rem}
    .ap-note{margin:0 0 14px;color:#6b7280;font-size:.95rem}
    .ap-required{color:#dc2626;font-weight:700}
    .ap-form{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
    .ap-field{display:flex;flex-direction:column;gap:6px}
    .ap-span-2{grid-column:1 / -1}
    .ap-help{color:#6b7280;font-size:.85rem}
    .ap-actions{display:flex;gap:10px;margin-top:4px}
    .ap-input,.ap-select,.ap-textarea,.ap-file{width:100%;padding:10px 12px;border:1px solid #D1D5DB;border-radius:10px;background:#fff;outline:0;transition:border-color .15s, box-shadow .15s;font-size:1rem}
    .ap-textarea{min-height:100px;resize:vertical}
    .ap-input:focus,.ap-select:focus,.ap-textarea:focus,.ap-file:focus{border-color:#4CAF50;box-shadow:0 0 0 3px rgba(76,175,80,.15)}
    @media (max-width:800px){ .ap-form{grid-template-columns:1fr} }
  </style>

{# ================== HOME NORMAL (TU CONTENIDO ORIGINAL) ================== #}
{% else %}

{% if messages %}
  <div id="flash" style="margin:12px 0;">
    {% for message in messages %}
      <div class="alert {{ message.tags }}" style="padding:10px 14px;border-radius:8px;margin-bottom:8px;
           {% if message.tags == 'success' %}background:#ecfdf5;color:#065f46;border:1px solid #34d399;
           {% elif message.tags == 'error' %}background:#fef2f2;color:#991b1b;border:1px solid #f87171;
           {% elif message.tags == 'info' %}background:#eff6ff;color:#1e3a8a;border:1px solid #60a5fa;
           {% else %}background:#f3f4f6;color:#111827;border:1px solid #e5e7eb;{% endif %}">
        üêæ {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}

<style>
  /* ====== Filtros (layout ordenado en 2 filas) ====== */
  .filters{
    display:grid;grid-template-columns:repeat(12,minmax(0,1fr));
    gap:12px;align-items:end;margin-bottom:18px
  }
  .filters .field{grid-column:span 12}
  .filters .field.search{grid-column:span 6}
  .filters .field.tipo{grid-column:span 3}
  .filters .field.sexo{grid-column:span 3}
  .filters .field.edad{grid-column:span 3}
  .filters .field.ubic{grid-column:span 6}
  .filters .actions{
    grid-column:span 3;display:flex;gap:10px;justify-content:flex-end;align-self:end
  }
  @media (max-width:900px){
    .filters .field.search{grid-column:span 12}
    .filters .field.tipo,.filters .field.sexo,.filters .field.edad{grid-column:span 6}
    .filters .field.ubic{grid-column:span 12}
    .filters .actions{grid-column:span 12;justify-content:flex-start}
  }
  @media (max-width:640px){
    .filters .field,.filters .actions{grid-column:span 12}
  }
  .filters label{display:block;font-size:.9rem;color:#374151;margin-bottom:6px}
  .filters input,.filters select{width:100%;padding:10px 12px;border:1px solid #D1D5DB;border-radius:8px;background:#fff}
  .btn{display:inline-block;padding:10px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
  .btn-primary{background:#4CAF50;color:#fff}
  .btn-secondary{background:#E5E7EB;color:#111827}

  .pet-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;align-items:stretch}
  .pet-card{grid-column:span 3;background:#fff;border:1px solid #E5E7EB;border-radius:12px;overflow:hidden;display:flex;flex-direction:column;height:100%}
  @media (max-width:1200px){.pet-card{grid-column:span 4}}
  @media (max-width:900px){.pet-card{grid-column:span 6}}
  @media (max-width:640px){.pet-card{grid-column:span 12}}

  .pet-thumb{aspect-ratio:4/3;background:#f2f4f7;overflow:hidden}
  .pet-thumb img{width:100%;height:100%;object-fit:cover;display:block}

  .pet-body{padding:14px 16px 16px;display:flex;flex-direction:column;gap:10px;flex:1;min-height:320px}
  .pet-name{margin:0;font-size:1.15rem;font-weight:700;color:#111827}
  .pet-meta{margin:0;color:#6b7280;font-size:.95rem}

  .pet-desc{margin:4px 0 0;color:#4b5563;font-size:.95rem;line-height:1.35;display:-webkit-box;-webkit-line-clamp:5;-webkit-box-orient:vertical;overflow:hidden}
  .pet-desc.expanded{-webkit-line-clamp:unset;max-height:none}
  .toggle-desc{background:none;border:0;color:#2563eb;cursor:pointer;padding:0;font-weight:600;align-self:flex-start}

  .msg-optional{width:100%;min-height:64px;max-height:260px;padding:10px 12px;border:1px solid #D1D5DB;border-radius:8px;resize:none;overflow:auto}
  .pet-actions{margin-top:auto;display:flex;flex-direction:column;align-items:stretch;gap:10px}
  .pet-actions .btn-primary{width:100%;padding-block:12px;border-radius:10px}
</style>

<div class="container">
  <h1 style="margin:0 0 14px;font-size:1.6rem;">Mascotas disponibles</h1>

  <form class="filters" method="get" action=".">
    <div class="field search">
      <label for="q">Buscar</label>
      <input id="q" name="q" value="{{ q|default:'' }}" placeholder="Nombre, raza, descripci√≥n‚Ä¶">
    </div>
    <div class="field tipo">
      <label for="tipo">Tipo</label>
      <select id="tipo" name="tipo">
        <option value="">‚Äî Tipo ‚Äî</option>
        {% for key,label in tipos %}
          <option value="{{ key }}" {% if key == tipo %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="field sexo">
      <label for="sexo">Sexo</label>
      <select id="sexo" name="sexo">
        <option value="">‚Äî Sexo ‚Äî</option>
        {% for key,label in sexos %}
          <option value="{{ key }}" {% if key == sexo %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="field edad">
      <label for="edad">Edad</label>
      <select id="edad" name="edad">
        <option value="">‚Äî Edad ‚Äî</option>
        {% for rango in rangos_edad %}
          <option value="{{ forloop.counter0 }}" {% if forloop.counter0|stringformat:'s' == edad %}selected{% endif %}>
            {{ rango.2 }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="field ubic">
      <label for="ubic">Ubicaci√≥n</label>
      <input id="ubic" name="ubic" value="{{ ubic|default:'' }}" placeholder="Ciudad/Regi√≥n">
    </div>
    <div class="actions">
      <button class="btn btn-primary" type="submit">Filtrar</button>
      <a class="btn btn-secondary" href="{% url 'home' %}">Limpiar</a>
    </div>
  </form>

  {% if mascotas %}
    <div class="pet-grid">
      {% for m in mascotas %}
        <article class="pet-card">
          <div class="pet-thumb">
            {% if m.foto %}<img src="{{ m.foto.url }}" alt="{{ m.nombre }}">{% else %}<img src="{% static 'img/placeholder_pet.jpg' %}" alt="Mascota">{% endif %}
          </div>

          <div class="pet-body">
            <h3 class="pet-name">{{ m.nombre }}</h3>
            <p class="pet-meta">{{ m.get_tipo_display }} ‚Ä¢ {{ m.edad }} meses ‚Ä¢ {{ m.get_sexo_display }}</p>

            <div class="pet-desc" id="desc-{{ m.id }}">{{ m.descripcion|default:"Sin descripci√≥n" }}</div>
            <button class="toggle-desc" data-target="desc-{{ m.id }}" type="button">Ver m√°s</button>

            {% if user.is_authenticated %}
              <form method="post" action="{% url 'solicitud_adopcion:crear_rapida' m.id %}" class="pet-actions">
                {% csrf_token %}
                <button class="btn btn-primary" type="submit">Solicitar adopci√≥n</button>
                <textarea class="msg-optional" name="mensaje" placeholder="Mensaje para la adopci√≥n (opcional)"></textarea>
              </form>
            {% else %}
              <div class="pet-actions">
                <a class="btn btn-primary" href="{% url 'login:login' %}?next={% url 'home' %}">Inicia sesi√≥n para solicitar</a>
              </div>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <p style="text-align:center;color:#6b7280;">No hay mascotas que coincidan con tu b√∫squeda.</p>
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  document.querySelectorAll('.toggle-desc').forEach(function(btn){
    var id = btn.getAttribute('data-target');
    var el = document.getElementById(id);
    if(el && el.scrollHeight <= el.clientHeight + 1){ btn.style.display = 'none'; }
    btn.addEventListener('click', function(){
      if(!el) return;
      el.classList.toggle('expanded');
      btn.textContent = el.classList.contains('expanded') ? 'Ver menos' : 'Ver m√°s';
    });
  });
  const autosize = ta => { ta.style.height='auto'; ta.style.height=Math.min(ta.scrollHeight,260)+'px'; };
  document.querySelectorAll('textarea.msg-optional').forEach(ta=>{ autosize(ta); ta.addEventListener('input', ()=>autosize(ta)); });
});
</script>

{% endif %} {# /ELSE (home normal) #}

{% endblock %}
