{% extends "base.html" %}
{% load static %}

{% block title %}Adopciones disponibles{% endblock %}

{% block content %}

<style>
  /* ---------- Filtros compactos ---------- */
  .filters {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 12px;
    align-items: end;
    margin-bottom: 18px;
  }
  .filters .field { grid-column: span 3; }
  .filters .field.wide { grid-column: span 6; }
  .filters .actions { grid-column: span 3; display: flex; gap: 10px; }
  @media (max-width: 900px) {
    .filters .field { grid-column: span 6; }
    .filters .field.wide { grid-column: span 12; }
    .filters .actions { grid-column: span 12; }
  }
  @media (max-width: 600px) {
    .filters .field { grid-column: span 12; }
  }

  /* ---------- Grid de mascotas ---------- */
  .pet-grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 24px;
  }
  @media (max-width: 1100px) { .pet-grid { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 640px)  { .pet-grid { grid-template-columns: 1fr; } }

  .pet-card {
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,.06);
    display: flex;
    flex-direction: column;
  }
  .pet-thumb { aspect-ratio: 4 / 3; background: #f2f4f7; overflow: hidden; }
  .pet-thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
  .pet-body { padding: 14px 16px 16px; display: flex; flex-direction: column; gap: 8px; }
  .pet-name { margin: 0; font-size: 1.15rem; font-weight: 700; color: #111827; }
  .pet-meta { margin: 0; color: #6b7280; font-size: .95rem; }
  .pet-desc { margin: 4px 0 0; color: #4b5563; font-size: .95rem; min-height: 3.1em; }
  .pet-actions { margin-top: 10px; display: flex; gap: 8px; }
  .btn {
    display: inline-block; text-align: center;
    padding: 10px 14px; border-radius: 8px; border: 0; cursor: pointer;
    font-weight: 600; text-decoration: none;
  }
  .btn-primary { background: #4CAF50; color: #fff; }
  .btn-primary:hover { filter: brightness(0.95); }

  /* Comentario compacto en la tarjeta */
  .pet-comment { margin-top: 6px; }
  .pet-comment textarea {
    width: 100%; resize: vertical; min-height: 60px; max-height: 160px;
    padding: 8px 10px; border: 1px solid #e5e7eb; border-radius: 8px;
    font-size: .95rem; color: #374151;
  }
</style>

<h2 class="hero-title" style="text-align:center;margin-bottom:14px;">Mascotas disponibles</h2>

<form method="get" class="filters">
  <div class="field wide">
    <input type="search" name="q" value="{{ q|default:'' }}" placeholder="Buscar por nombre, raza, descripción…" class="form-control" style="width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;">
  </div>

  <div class="field">
    <select name="tipo" class="form-control" style="width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;">
      <option value="">— Tipo —</option>
      {% for val, label in tipos %}
        <option value="{{ val }}" {% if tipo == val %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="field">
    <select name="sexo" class="form-control" style="width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;">
      <option value="">— Sexo —</option>
      {% for val, label in sexos %}
        <option value="{{ val }}" {% if sexo == val %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="field">
    <select name="edad" class="form-control" style="width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;">
      <option value="">— Edad —</option>
      {% for r in rangos_edad %}
        <option value="{{ forloop.counter0 }}" {% if edad == forloop.counter0|stringformat:"s" %}selected{% endif %}>{{ r.2 }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="field">
    <select name="ubicacion" class="form-control" style="width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;">
      <option value="">— Ubicación —</option>
      {% for u in ubicaciones %}
        <option value="{{ u }}" {% if ubic == u %}selected{% endif %}>{{ u }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="actions">
    <button class="btn btn-primary" type="submit" style="flex:1">Filtrar</button>
    <a class="btn btn-outline" style="flex:1;border:1px solid #e5e7eb;" href="{% url 'home' %}">Limpiar</a>
  </div>
</form>

{% if mascotas %}
  <div class="pet-grid">
    {% for m in mascotas %}
      <article class="pet-card">
        <div class="pet-thumb">
          {% if m.foto %}
            <img src="{{ m.foto.url }}" alt="{{ m.nombre }}">
          {% else %}
            <img src="{% static 'blog/img/default-cat.svg' %}" alt="{{ m.nombre }}">
          {% endif %}
        </div>
        <div class="pet-body">
          <h3 class="pet-name">{{ m.nombre }}</h3>
          <p class="pet-meta">
            {{ m.get_tipo_display }} · {{ m.raza|default:"Mestizo" }} · {{ m.ubicacion|default:"" }}
          </p>
          <p class="pet-desc">{{ m.descripcion|default:"" |truncatechars:120 }}</p>

          {% if request.user.is_authenticated %}
            <form method="post" action="{% url 'solicitud_adopcion:crear_rapida' m.id %}">
              {% csrf_token %}
              <div class="pet-comment">
                <textarea name="mensaje" placeholder="¿Por qué quieres adoptar a {{ m.nombre }}? (opcional)"></textarea>
              </div>
              <div class="pet-actions">
                <button class="btn btn-primary" type="submit">Solicitar adopción</button>
              </div>
            </form>
          {% else %}
            <div class="pet-actions">
              <a class="btn btn-primary" href="{% url 'login:login' %}?next={% url 'home' %}">Inicia sesión para solicitar</a>
            </div>
          {% endif %}
        </div>
      </article>
    {% endfor %}
  </div>
{% else %}
  <p style="text-align:center;color:#6b7280;">No hay mascotas que coincidan con tu búsqueda.</p>
{% endif %}

{% endblock %}